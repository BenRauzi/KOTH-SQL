/*
	ArmA 3 King of Hill
	Code written by Sa-Matra
	Using this code without Sa-Matra's direct permission is forbidden
	
	Special build for Gamed.de
	
	Build ETYKMBSIGDHGNALL
*/
#include "hpp\idcs.hpp"
#include "hpp\defines.hpp"
kg5tli={private["_0a"];disableSerialization;_0a=_this;[_0a,""]call bis_fnc_guiEffectTiles;true call kgsmhw;true call kgl2wn;(_0a displayCtrl kgoaw2)ctrlShow false;(_0a displayCtrl kg9i4v)ctrlShow false;(_0a displayCtrl kgrc1y)ctrlSetText kgfmtd;(_0a displayCtrl kgrc1y)ctrlShow!isStreamFriendlyUIEnabled;true spawn kg24t1;};kg5u7p={private["_0nc"];_0nc=true;if(isStreamFriendlyUIEnabled)then{_0nc=["Group management menu is not stream safe and will display nicknames of people on the server. Make sure you hide this menu from your stream before you press ""OK"".","Stream Safe Warning",true,true]call BIS_fnc_GUImessage;};if(_0nc)then{createDialog "KingOfHill_Groups";};};kg24t1={private["_0a"];disableSerialization;_0a=uiNamespace getVariable "KingOfHill_Groups";while{!isNull(_0a)}do{_0oc=count units group player;waitUntil{isNull(_0a)||((count units group player)!=_0oc)};if(!isNull(_0a))then{true call kgsmhw;true call kgl2wn;};};};kgsmhw={private["_0a","_0pc","_0qc"];private["_0rc","_0sc","_0tc","_0uc"];_0a=uiNamespace getVariable "KingOfHill_Groups";_0pc=_0a displayCtrl kg71fg;_0qc=_0a displayCtrl kgw4vo;if((count units group player)==1)then{_0qc ctrlSetStructuredText parseText localize "STR_KOH_Dlg_Groups_StatusAlone";}else{if((leader group player)==player)then{_0qc ctrlSetStructuredText parseText localize "STR_KOH_Dlg_Groups_StatusLeader";}else{_0qc ctrlSetStructuredText parseText localize "STR_KOH_Dlg_Groups_StatusMember";};};_0rc="你的小队:";_0sc=1;{_0sc=_0sc+1;_0tc=if(leader group player==_x)then{"leader"}else{"unit"};_0uc=[];_0rc=format["%1<br/>%2",_0rc,format["<img image='i\grp_%1.paa' size='0.9'/> %3%2",_0tc,if(isStreamFriendlyUIEnabled&&(_x==player))then{localize "STR_KOH_Me"}else{name _x},if(count(_0uc)==0)then{""}else{format["<img image='%2' size='0.9'/> ",_0uc select 0,_0uc select 1]}]];}forEach(units group player);_0pc ctrlSetStructuredText parseText _0rc;_0pc ctrlSetPosition[0,0,0.4-((2/250)+(1/250))*(safezoneH/safezoneW),(((((safezoneW/safezoneH)min 1.2)/1.2)/25)*0.8)*_0sc];_0pc ctrlCommit 0;};kgl2wn={private["_0a","_0vc","_0pc","_0wc","_0qc"];private["_0c","_01c","_02c","_03c","_0yc","_0zc"];_0a=uiNamespace getVariable "KingOfHill_Groups";_0vc=_0a displayCtrl kgd21c;_0pc=_0a displayCtrl kg71fg;_0wc=_0a displayCtrl kgoaw2;_0xc=_0a displayCtrl kg9i4v;_0qc=_0a displayCtrl kgw4vo;lbClear _0vc;_0yc=[];{if(kguvm4 in(_x getVariable["invites",[]]))then{_0yc pushBack(getPlayerUID _x);};}forEach playableUnits;_0zc=player getVariable["invites",[]];{if(side _x==playerSide)then{_0c=lbSize _0vc;_0vc lbAdd format["%1",if(isStreamFriendlyUIEnabled&&(_x==player))then{localize "STR_KOH_Me2"}else{name _x}];_01c="i\grp_free.paa";_02c="FREE";if(((getPlayerUID _x)in _0yc)&&((getPlayerUID _x)in _0zc))then{_02c="BOTH";_01c="i\grp_both.paa";}else{if((getPlayerUID _x)in _0yc)then{_02c="GOT";_01c="i\grp_got.paa";};if((getPlayerUID _x)in _0zc)then{_02c="SENT";_01c="i\grp_sent.paa";};};if(count units group _x>1)then{if(group _x==group player)then{if(_x==(leader group player))then{_01c="i\grp_leader.paa";}else{_01c="i\grp_unit.paa";};_02c="GROUP";}else{_01c="i\grp_busy.paa";_02c="BUSY";if(leader group _x==_x)then{if((getPlayerUID _x)in _0yc)then{_02c="GOT";_01c="i\grp_got.paa";};};};};_0vc lbSetPicture[_0c,_01c];_03c=format["grouplist_%1",getPlayerUID _x];_0vc lbSetData[_0c,_03c];uiNamespace setVariable[_03c,[_x,getPlayerUID _x,_02c]];}}forEach playableUnits;true call kgxm97;};kgxm97={private["_0a","_0vc"];_0a=uiNamespace getVariable "KingOfHill_Groups";_0vc=_0a displayCtrl kgd21c;[_0vc,lbCurSel _0vc]call kgazfh;};kgazfh={_03c=(_this select 0)lbData(_this select 1);_04c=uiNamespace getVariable[_03c,[]];uiNamespace setVariable["grouplist_selected",_04c];private["_0a","_0wc","_0xc"];_0a=uiNamespace getVariable "KingOfHill_Groups";_0wc=_0a displayCtrl kgoaw2;_0xc=_0a displayCtrl kg9i4v;_0wc ctrlShow false;_0xc ctrlShow false;if((_04c select 0==player)||false)then{}else{switch((_04c select 2))do{case "FREE":{if(leader group player==player)then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionSendInvite";uiNamespace setVariable["grouplist_b1","INVITE"];};};case "GROUP":{if(leader group player==player)then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionKick";uiNamespace setVariable["grouplist_b1","KICK"];}else{if((leader group player)==(_04c select 0))then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionLeave";uiNamespace setVariable["grouplist_b1","LEAVE"];};};};case "BOTH":{if(leader group player==player)then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionCancelInvite";uiNamespace setVariable["grouplist_b1","INVITE_REMOVE"];_0xc ctrlShow true;_0xc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionAcceptInvite";uiNamespace setVariable["grouplist_b2","INVITE_ACCEPT"];};};case "GOT":{if(leader group player==player)then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionSendInvite";uiNamespace setVariable["grouplist_b1","INVITE"];_0xc ctrlShow true;_0xc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionAcceptInvite";uiNamespace setVariable["grouplist_b2","INVITE_ACCEPT"];};};case "SENT":{if(leader group player==player)then{_0wc ctrlShow true;_0wc ctrlSetText localize "STR_KOH_Dlg_Groups_ActionCancelInvite";uiNamespace setVariable["grouplist_b1","INVITE_REMOVE"];};};};};};kgm5ra={_this=_this+1;_05c=uiNamespace getVariable format["grouplist_b%1",_this];_04c=uiNamespace getVariable["grouplist_selected",[]];switch(_05c)do{case "INVITE":{if(!isNull(_04c select 0))then{_0zc=player getVariable["invites",[]];if!((_04c select 1)in _0zc)then{_0zc pushBack(_04c select 1);player setVariable["invites",_0zc,true];};true call kgl2wn;}else{hint localize "STR_WL_Dlg_Groups_HintStatusChanged";true call kgl2wn;};};case "INVITE_REMOVE":{[player,(_04c select 1)]call kg3lqg;true call kgl2wn;};case "INVITE_ACCEPT":{if(((count units group player)==1)&&!isNull(_04c select 0)&&([_04c select 1,kguvm4]call kgtcux))then{[player]joinSilent(group(_04c select 0));if(count(player getVariable["invites",[]])>0)then{player setVariable["invites",nil,true];};}else{hint localize "STR_WL_Dlg_Groups_HintStatusChanged";};};case "KICK":{if(((count units group player)>1)&&(group player==(group(_04c select 0))))then{[(_04c select 0)]joinSilent(createGroup playerSide);[player,(_04c select 1)]call kg3lqg;}else{hint localize "STR_WL_Dlg_Groups_HintStatusChanged";};};case "LEAVE":{if(((count units group player)>1))then{[player]joinSilent(createGroup playerSide);_05b=({if(getPlayerUID _x==(_04c select 1))exitWith{_x}}forEach playableUnits);if(!isNil{_05b})then{[_05b,kguvm4]call kg3lqg;};}else{hint localize "STR_WL_Dlg_Groups_HintStatusChanged";};};};};kgbeni={};kgma1x={};kg3lqg={private["_05b","_uid"];_05b=_this select 0;_uid=_this select 1;if(_uid in(_05b getVariable["invites",[]]))then{_05b setVariable["invites",(_05b getVariable["invites",[]])-[_uid],true];};};kgcgd6={};kgtcux={private["_06c","_07c"];_06c=_this select 0;_07c=_this select 1;_05b=({if(getPlayerUID _x==_06c)exitWith{_x}}forEach playableUnits);if(!isNil{_05b})then{_07c in(_05b getVariable["invites",[]])}else{false};};