/*
	ArmA 3 King of Hill
	Code written by Sa-Matra
	Using this code without Sa-Matra's direct permission is forbidden
	
	Special build for Gamed.de
	
	Build ETYKMBSIGDHGNALL
*/
#include "hpp\idcs.hpp"
#include "hpp\defines.hpp"
kgqciu=[kgcd1f,kgeus2,kg8bb7,kghs7s,kgvc2n,kg8rg5];kgiypm={if(isNil{kgt2cq})exitWith{true};if(diag_tickTime-(kgt2cq select 0)>5)exitWith{true};false};kg2sjx={disableSerialization;private["_0a"];_0a=_this;[_0a,""]call bis_fnc_guiEffectTiles;(_0a displayCtrl kgms9b)ctrlShow false;(_0a displayCtrl kg2dgh)ctrlSetText kgfmtd;(_0a displayCtrl kg2dgh)ctrlShow!isStreamFriendlyUIEnabled;kge3df=[];for "_i" from 0 to count(kgqciu)-1 do{kge3df set[_i,ctrlPosition(_0a displayCtrl(kgqciu select _i))];};0 call kg4iad;};kg4iad={kgf4u5=_this;disableSerialization;private["_0a"];_0a=uiNamespace getVariable "KingOfHill_Vehicles";(_0a displayCtrl kgms9b)ctrlShow false;call kgjxg7;};kg5shr={format["<t color='#aaffaa'>%1 $</t>",_this];};kg8628={_0ba=false;_01b=(if(isNil{_this select 2})then{"CfgWeapons"}else{_this select 2});_02b=configFile>>_01b>>(_this select 0);for "_i" from 0 to 4 do{_02b=inheritsFrom(_02b);if(configName(_02b)==_this select 1)exitWith{_0ba=true;};};_0ba};kgxkk2={private["_0ec","_01l","_02l"];_0ec=_this;_01l=[];_02l=[];if(typeName _0ec==typeName[])then{_0ec=_this select 0;_01l=(_this select 1)apply{toLower _x};_02l=(_this select 2)apply{toLower _x};};private["_0mb","_0bd"];_0mb=configFile>>"CfgVehicles">>_0ec;_0bd=getArray(_0mb>>"weapons")apply{toLower _x};private["_0nb"];_0nb=_0mb>>"turrets";for "_i" from 0 to(count _0nb-1)do{private["_0ob","_0pb"];_0ob=_0nb select _i;_0pb=_0ob>>"turrets";{_0bd pushBack toLower _x;}forEach getArray(_0ob>>"weapons");for "_j" from 0 to(count _0pb-1)do{private["_0qb"];_0qb=_0pb select _j;{_0bd pushBack toLower _x;}forEach getArray(_0qb>>"weapons");};};{private _03l=getText(_x>>"attachment");if(_03l!="")then{private _0xh=toLower getText(configFile>>"CfgMagazines">>_03l>>"pylonWeapon");_0bd pushBackUnique _0xh;};}forEach("true" configClasses(_0mb>>"Components">>"TransportPylonsComponent">>"pylons"));_0bd=_0bd-_01l+_02l;private["_08i"];_08i=[];{_04l=_x;if({if([_04l,_x]call kg1gil)exitWith{1};}count["CarHorn","SmokeLauncher"]==0)then{_08i set[count _08i,getText(configFile>>"CfgWeapons">>_04l>>"displayname")];};}forEach _0bd;private["_0s"];_0s="";for "_i" from 0 to(count(_08i)-1)do{_0s=_0s+format["%1%2",(switch(true)do{case(_i==0):{""};default{", "};}),_08i select _i];};_0s};kg5kyk={private["_0mb","_0rb","_0ub","_05l"];_0mb=configFile>>"CfgVehicles">>_this;_0rb=_this isKindOf "Air";_05l=getNumber(_0mb>>"transportsoldier");_0ub=(getNumber(_0mb>>"hasdriver")==1);private["_0nb","_0sb","_06l","_07l"];_0nb=_0mb>>"turrets";_0sb=[];_06l=false;_07l=false;for "_i" from 0 to(count _0nb-1)do{private["_0ob","_0pb"];_0ob=_0nb select _i;_0pb=_0ob>>"turrets";switch(true)do{case(getNumber(_0ob>>"isPersonTurret")==1):{_05l=_05l+1;};case(getNumber(_0ob>>"iscopilot")==1&&_0rb&&!_06l):{_06l=true;};case(getNumber(_0ob>>"primaryobserver")==1&&!_07l):{_07l=true;};default{_0sb=_0sb+[[_i]];};};for "_j" from 0 to(count _0pb-1)do{private["_0qb"];_0qb=_0pb select _j;switch(true)do{case(getNumber(_0qb>>"isPersonTurret")==1):{_05l=_05l+1;};case(getNumber(_0qb>>"iscopilot")==1&&_0rb&&!_06l):{_06l=true;};case(getNumber(_0qb>>"primaryobserver")==1&&!_07l):{_07l=true;};default{_0sb=_0sb+[[_i,_j]];};};};};private["_08i"];_08i=[];if(_0ub)then{_08i set[count _08i,(if(_0rb)then{"飞行员"}else{"驾驶员"})];};if(_06l)then{_08i set[count _08i,"副驾驶"];};if(count(_0sb)>0)then{if(count(_0sb)>1)then{_08i set[count _08i,format["%1个炮手位",count(_0sb)]];}else{_08i set[count _08i,"炮手位"];};};if(_07l)then{_08i set[count _08i,"车长位"];};if(_05l>0)then{if(_05l>1)then{_08i set[count _08i,format["%1个乘客位",_05l]];}else{_08i set[count _08i,"1个乘客位"];};};private["_0s"];_0s="";for "_i" from 0 to(count(_08i)-1)do{_0s=_0s+format["%1%2",(switch(true)do{case(_i==0):{""};case(_i==count(_08i)-1):{"和"};default{", "};}),_08i select _i];};_0s};kgzxva={private "_08l";_08l=0;{_08l=_08l max _x}forEach kgvsc7;_08l;};kgjxg7={disableSerialization;private["_0a"];_0a=uiNamespace getVariable "KingOfHill_Vehicles";(_0a displayCtrl kgms9b)ctrlShow true;private["_09l","_0am","_0bm"];_09l=switch(kgf4u5)do{case 0:{database_vehicles_groundList};case 1:{database_vehicles_aircraftList};case 2:{database_vehicles_planesList};};_0am=[];for "_i" from 0 to count(_09l)-1 do{if(call(_09l select _i select 4))then{if(playerSide in(_09l select _i select 5))then{_0am set[count _0am,_i];};};};_0bm=call kgzxva;kgblg1=_0am;private["_08j","_09i"];_08j=((kge3df select(kgqciu find kg8rg5))select 2);_09i=((kge3df select(kgqciu find kg8rg5))select 3);for "_i" from 0 to 99 do{private["_0we","_0cm","_0cl","_0al","_0dm","_0qc","_0dl"];_0cm=_0a displayCtrl kgcd1f+_i;_0cl=_0a displayCtrl kgeus2+_i;_0al=_0a displayCtrl kg8bb7+_i;_0dm=_0a displayCtrl kghs7s+_i;_0qc=_0a displayCtrl kgvc2n+_i;_0dl=_0a displayCtrl kg8rg5+_i;_0we=[_0cm,_0cl,_0al,_0dm,_0qc,_0dl];if(_i<count(_0am))then{for "_j" from 0 to count(_0we)-1 do{private["_pos"];_pos=+(kge3df select _j);_pos set[0,(_08j*(_i%2))+(_pos select 0)];_pos set[1,(_09i*floor(_i/2))+(_pos select 1)];(_0we select _j)ctrlSetPosition _pos;(_0we select _j)ctrlCommit 0;};private["_0v","_name","_0ec","_0g","_0zj","_0em","_0pe","_0gm","_0hm","_07i","_0fm"];_0v=_09l select(_0am select _i);_name=(_0v select 0);_0ec=call(_0v select 1);_0g=call(_0v select 2);_0zj=call(_0v select 6);_0em=_0v select 9;_0pe={if(kgge9y find _x==-1)exitWith{_x}}forEach((_0v select 3)+[-1]);_0fm=false;_0gm=(_0ec call kg5kyk);_0hm=([_0ec,_0v select 7,_0v select 8]call kgxkk2);_07i=format["装甲: %1. 速度: %2.",getNumber(configFile>>"CfgVehicles">>_0ec>>"armor"),getNumber(configFile>>"CfgVehicles">>_0ec>>"maxspeed")];_0cm ctrlSetText getText(configFile>>"CfgVehicles">>_0ec>>"picture");_0cl ctrlSetText getText(configFile>>"CfgVehicles">>_0ec>>"displayname");_0dm ctrlSetStructuredText parseText(if(_0zj==0)then{"Free"}else{(_0zj call kg5shr)});_0qc ctrlSetStructuredText parseText format["%1%2%3",_0gm,if(_0hm=="")then{""}else{format[". %1: %2","武器配置",_0hm]},if(_07i=="")then{""}else{format[".<br/>%1",_07i]}];_0c=(kgqmj3 select 0)find _name;if(_0c>-1)then{_0fm=((kgqmj3 select 1 select _0c)<0);};if(switch(true)do{case(_0fm):{_0dl ctrlSetStructuredText parseText format["<br/>DISABLED"];true;};case(_0pe!=-1):{_0dl ctrlSetStructuredText parseText format["<br/>""%1"" REQUIRED",database_loadout_perksList select(database_loadout_perksIndexes find _0pe)select 4];true;};case(kgsoxm<_0g):{_0dl ctrlSetStructuredText parseText format["<br/>需要达到 %1 级",_0g];true;};case(_0c>-1&&{(kgqmj3 select 1 select _0c)>_0bm}):{_0dl ctrlSetStructuredText parseText format["<br/>%1/%2 SCORE",_0bm,(kgqmj3 select 1 select _0c)];true;};default{false};})then{_0al ctrlEnable false;}else{_0al ctrlEnable true;_0dl ctrlShow false;};}else{{_x ctrlShow false;_x ctrlSetPosition[0,0,-0.1,-0.1];_x ctrlCommit 0;}forEach _0we;};};};kgsiku={if(kgxbuo+1>diag_tickTime)exitWith{};private["_0c","_09l"];_0c=kgblg1 select _this;_09l=switch(kgf4u5)do{case 0:{database_vehicles_groundList};case 1:{database_vehicles_aircraftList};case 2:{database_vehicles_planesList};};if(kgf4u5==2&&floor(kg1lxr-diag_tickTime)>0)exitWith{hint format["请等待 %1 之后再购买",(kg1lxr-diag_tickTime)call kgug1l];};if(!isServer&&(kgf4u5!=2)&&{alive(_x select 0)&&(_x select 0)call kgjvx9}count kg8u9s>=4)exitWith{hint "请不要在基地刷大量载具！";kgt2cq=nil;closeDialog 0;};private["_0zj"];_0zj=call(_09l select _0c select 6);if((_0zj<=300)&&(diag_tickTime<(kgs4mv+60)))exitWith{hint "Cannot purchase cheap vehicles too often";kgt2cq=nil;closeDialog 0;};if(kg4re9>=_0zj)then{kggrex=[player,call(_09l select _0c select 1),kgf4u5,_0zj];publicVariableServer "kggrex";kgt2cq=[diag_tickTime,_0zj];if(_0zj<=100)then{kgs4mv=diag_tickTime;};kgxbuo=diag_tickTime;closeDialog 0;}else{false call kgbz2a;};};kgv2g2={_0im=database_vehicles_boatsList select(switch(true)do{case kgva7i:{1};default{0};});_0zj=call(_0im select 6);if(kg4re9<_0zj)exitWith{false call kgbz2a;false;};kgt2cq=[diag_tickTime,_0zj];kgo59q=[player,call(_0im select 1),_0zj];publicVariableServer "kgo59q";true;};kgcauz={if(isNull(_this))exitWith{hint "无法购买载具，基地内载具太多";};private["_0zj"];_0zj=kgt2cq select 1;if(_0zj>0)then{kg4re9=kg4re9-_0zj;call kgm9k5;call kgttgb;playSound "KOH_Cash";[_this,_0zj]spawn{sleep 20;if(!alive(_this select 0))then{[[-1,kgub4d,(_this select 1)]]call kgt98j;};};};kg8u9s set[count kg8u9s,[_this,typeOf _this,serverTime,_0zj]];player reveal[_this,4];switch(true)do{case(kggrex select 2==2):{[getPosATL _this,5,{}]call kgyzs8;0 preloadObject _this;moveOut player;player moveInDriver _this;kg61p9=diag_tickTime+2;[player,(switch(side group player)do{case opfor:{"O_Pilot"};case independent:{"I_Pilot"};default{"B_Pilot"};})]call kg8d8a;call kgfx6i;if(call kg9lxi)then{call kgl9rw;};call kgu3t4;kgi3wj=[_this,player];publicVariable "kgi3wj";};default{private["_0jm","_0km"];_0jm=getPosATL player;_0km=getPosATL _this;player setDir((_0km select 0)-(_0jm select 0))atan2((_0km select 1)-(_0jm select 1));player switchMove(animationState player);};};kgt2cq=nil;};
#define kg9s24	"B_Parachute_02_F"
#define kgr52c	"O_Parachute_02_F"
#define kgv4e2	"I_Parachute_02_F"
#define kgppg4	"B_Parachute_02_F"
kg1kbw={if(isNull(_this))exitWith{};private["_0zj"];_0zj=kgt2cq select 1;if(_0zj>0)then{kg4re9=kg4re9-_0zj;call kgm9k5;call kgttgb;playSound "KOH_Cash";};kg8u9s set[count kg8u9s,[_this,typeOf _this,serverTime,_0zj]];player reveal[_this,4];_this spawn{waitUntil{local _this};_pos=getPos player;_pos resize 2;_this setVehiclePosition[_pos,[],5,""];player moveInAny _this;};kgt2cq=nil;};kgk78q={kg8x89=player;publicVariableServer "kg8x89";};kgu3t4={kgggn4=player;publicVariableServer "kgggn4";};"kghr7y" addPublicVariableEventHandler{kg1lxr=diag_tickTime+(_this select 1);};