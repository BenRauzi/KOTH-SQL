/*
	ArmA 3 King of Hill
	Code written by Sa-Matra
	Using this code without Sa-Matra's direct permission is forbidden
	
	Special build for Gamed.de
	
	Build ETYKMBSIGDHGNALL
*/
#include "hpp\idcs.hpp"
#define kgnxt2		0
#define kg72d6		1
#define kgh3s3		100
#define kg92ex			(!isNil "c_proving_ground_balca_satcam")
kgrrdk={switch(_this)do{case blufor:{"A3\ui_f\data\map\diary\icons\playerWest_ca.paa"};case opfor:{"A3\ui_f\data\map\diary\icons\playerEast_ca.paa"};case independent:{"A3\ui_f\data\map\diary\icons\playerGuer_ca.paa"};default{"A3\ui_f\data\map\diary\icons\playerCiv_ca.paa"};};};kgla5w={kgko9o cutrsc["KingOfHill_IconsHUD","PLAIN"];kggc9g=0;kgjf33=false;kgbr3v=false;kgfvug=kgnxt2;kgjaus=playerSide call kgrrdk;kg8hd3=["B_UAV_AI","O_UAV_AI","I_UAV_AI"];kgbked=[];kgkg8f=[];kggkd1=0;kg82fs=0;kgdqul=0;kgdl67=0;kg6xaz=format["<img image='%1'/>",kgjaus];kgw618=parseText kg6xaz;kg8oug=format["<img image='%1'/>","\A3\ui_f\data\igui\rscingameui\rscdisplayvoicechat\microphone_ca.paa"];kgtsjj=[];[{private["_09b","_0fh","_pos","_0gh"];_0fh=[];_09b=kgbgkr;_0gh=(((kg92ex||missionNamespace getVariable["kg9d82",""]!="")&&kgjf33)||missionNamespace getVariable["kgskxp",kgrdur]==kgze3i);{if((_0hh distance(getPosASL _x))<_09b)then{if(((_x!=player)&&(side group _x==playerSide))||_0gh)then{if(!((typeOf _x)in kg8hd3))then{_pos=getPosASL _x;_pos set[2,(_pos select 2)+2];if(_pos select 2<0)then{_pos set[2,0.5];};if(!terrainIntersectASL[_0hh,_pos])then{_x call kgcjfe;_0fh set[count _0fh,[_x,0]];};};};};}forEach kgnine;if(count(kgtsjj)>0)then{_0fh=_0fh+kgtsjj;};_0fh},{_0ih=missionNamespace getVariable["kgskxp",kgrdur]==kgze3i;{if(alive(_x select 0)&&kggkd1<(kgh3s3-1))then{_05b=_x select 0;_0jh=_x select 1;_pos=visiblePosition _05b;_pos set[2,((_05b modelToWorld(_05b selectionPosition "head"))select 2)+0.5];_0kh=worldToScreen _pos;if(_0kh call kgjd9l)then{_0lh=_0mh distance _pos;_0nh=[_0kh,_0lh]call kgoued;_0oh=_0nh select 0;_0ph=_0nh select 1;_0gf=_0nh select 2;_09e=_0nh select 3;if(vehicle _05b!=_05b)then{_09e=0;};if(vehicle _05b==vehicle player&&player!=_05b)then{_09e=0.7;};_0w=_0a displayCtrl(kg3m58+kggkd1);_0w ctrlSetPosition[_0oh,_0ph,0.5,0.05*(SafeZoneW/1.5)];_0w ctrlSetScale _0gf;if(getPlayerChannel _05b>-1)then{if(group player==group _05b)then{_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Fullname_Mic_Group");}else{_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Fullname_Mic");};_0w ctrlSetFade 0;}else{if(kgjf33)then{if(group player==group _05b)then{_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Fullname_Group");}else{_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Fullname");};_0w ctrlSetFade 0;}else{_0w ctrlSetStructuredText kgw618;_0w ctrlSetFade _09e;};};if((kg92ex&&kgjf33)||_0ih)then{_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Debugname");};_0w ctrlCommit 0;kggkd1=kggkd1+1;if(kgjf33&&_0gf>=0.6)then{_0w=_0a displayCtrl(kggo2e+kgdqul);_0w ctrlSetPosition[_0oh-(0.019*_0gf*0.8),_0ph+0.002,0.1,0.04];_0w ctrlSetScale _0gf*0.8;_0w ctrlSetFade(if(kgjf33)then{0}else{_09e});_0w ctrlSetStructuredText(_05b getVariable "IconsHUD_Level");_0w ctrlCommit 0;kgdqul=kgdqul+1;};};};}forEach(kgkg8f select _this);},1]call kg77o3;[{private["_0fh","_pos"];_0fh=[];{if(_0hh distance ATLtoASL(_x select 0)<(_x select 2))then{_0fh set[count _0fh,_x];};}forEach kglcwt;_0fh},{{if(kggkd1<(kgh3s3-1))then{_pos=(_x select 0);_0kh=worldToScreen _pos;if(_0kh call kgjd9l)then{_0oh=_0kh select 0;_0ph=_0kh select 1;_0lh=_0mh distance _pos;_0qh=_0lh/_0rh;_0gf=0.99 min(((1-(_0qh/40))max 0.35)+0.05);_0w=_0a displayCtrl(kg3m58+kggkd1);_0w ctrlSetPosition[_0oh-0.5*_0gf/2,_0ph,0.5,0.04*2];_0w ctrlSetScale _0gf;_0w ctrlSetStructuredText(_x select 1);_0w ctrlSetFade((((_0qh-10)/20)max 0)min 1);_0w ctrlCommit 0;kggkd1=kggkd1+1;};};}forEach(kgkg8f select _this);},1]call kg77o3;kglcwt=[];true spawn{private["_02d","_0wa","_pos"];_02d=kghzyg select(kgubgt find playerSide);waitUntil{(_02d select 0)distance(positionCameraToWorld[0,0,0])<100};sleep 1;_0wa=[];for "_i" from 0 to count(_02d)-1 do{private["_0sh","_03b"];_0sh=(_02d select _i);_03b=boundingBox _0sh;_pos=getPosATL _0sh;_pos set[2,(switch(typeOf _0sh)do{case "MapBoard_altis_F":{(_pos select 2)+2.5};case "Land_Pallet_MilBoxes_F":{(_pos select 2)+1.7};case "Land_Laptop_unfolded_F":{(_pos select 2)+0.9};default{((_0sh modelToWorld(_0sh selectionPosition "head"))select 2)+0.7};})];_0wa set[_i,_pos];};kglcwt=[[_0wa select 0,parseText "<t align='center'>购买武器<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50],[_0wa select 1,parseText "<t align='center'>选择服装<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50],[_0wa select 2,parseText "<t align='center'>选择技能<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50],[_0wa select 3,parseText "<t align='center'>购买载具<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50],[_0wa select 4,parseText "<t align='center'>服务器规则<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50],[_0wa select 5,parseText "<t align='center'>补给弹药<br/><img image='i\arrowdown2.paa' size='0.5'/></t>",50]];};kglcgu=format["<img image='%1' color='#%2'/>","a3\ui_f\data\map\VehicleIcons\pictureheal_ca.paa","ee0000"];kgal7m=parseText kglcgu;[{private["_0fh","_pos","_09b"];_0fh=[];_09b=kgbgkr;{if((_x getVariable["revive_side",civilian]==playerSide)&&alive(_x getVariable["revive_player",objNull])&&((_0hh distance(getPosASL _x))<_09b))then{_pos=getPosASL _x;_pos set[2,(_pos select 2)+2];if(_pos select 2<0)then{_pos set[2,0.5];};if(!terrainIntersectASL[_0hh,_pos])then{if(isnil{_x getVariable "IconsHUD_Body_Fullname"})then{_x setVariable["IconsHUD_Body_Fullname",parseText format["%1 %2",kglcgu,_x getVariable["revive_name","Player"]]];};if(isnil{_x getVariable "IconsHUD_Body_Fullname_Group"})then{_x setVariable["IconsHUD_Body_Fullname_Group",parseText format["%1 <t color='#55cc55'>%2</t>",kglcgu,_x getVariable["revive_name","Player"]]];};_0fh set[count _0fh,_x];};};}forEach kgonou;_0fh},{{if(kggkd1<(kgh3s3-1))then{_0o=_x;_pos=(if(isNull objectParent _0o)then{_0o modelToWorld(_0o selectionPosition "head")}else{(if(surfaceIsWater(getPosASL _0o))then{visiblePositionASL _0o}else{visiblePosition _0o})});_pos set[2,(_pos select 2)+0.5];_0kh=worldToScreen _pos;if(_0kh call kgjd9l)then{_0lh=_0mh distance _pos;_0nh=[_0kh,_0lh]call kgoued;_0oh=_0nh select 0;_0ph=_0nh select 1;_0gf=_0nh select 2;_09e=_0nh select 3;if(vehicle _0o!=_0o)then{_09e=0;};if(vehicle _0o==vehicle player&&player!=_0o)then{_09e=0.7;};_0w=_0a displayCtrl(kg3m58+kggkd1);_0w ctrlSetPosition[_0oh,_0ph,0.5,0.05*(SafeZoneW/1.5)];_0w ctrlSetScale _0gf;if(kgjf33)then{if(group player==_0o getVariable["revive_group",grpNull])then{_0w ctrlSetStructuredText(_0o getVariable "IconsHUD_Body_Fullname_Group");}else{_0w ctrlSetStructuredText(_0o getVariable "IconsHUD_Body_Fullname");};_0w ctrlSetFade 0;}else{_0w ctrlSetStructuredText kgal7m;_0w ctrlSetFade _09e;};_0w ctrlCommit 0;kggkd1=kggkd1+1;};};}forEach(kgkg8f select _this);},1]call kg77o3;[{private "_0fh";_0fh=[];{if(alive _x)then{if(_0hh distance(getPosWorld _x)<150)then{_0fh set[count _0fh,_x];};};}forEach kgbkl7;_0fh},{{if(alive _x)then{_0lh=_0mh distance _x;_0gf=((1-(_0lh/70))max 0.1)min 1;_0gf=_0gf*_0rh;_0mf=linearConversion[0.1,0.5,_0gf,0,1,false]min 0.3;drawIcon3D["\A3\ui_f\data\map\markers\military\circle_CA.paa",[1,0,0,_0mf],ASLtoAGL(getPosWorld _x),_0gf,_0gf,0,"",2,0,"PuristaMedium"];};}forEach(kgkg8f select _this);},0]call kg77o3;[{private "_0fh";_0fh=[];{if(alive _x)then{if(_0hh distance(getPosWorld _x)<kgbgkr)then{if(!terrainIntersectASL[_0hh,(getPosWorld _x)])then{_0fh pushBack _x;};};};}forEach kg9nxt;_0fh},{{if(alive _x)then{if!(local _x&&cameraView=="GUNNER")then{_0gf=0.5;_0mf=0.7;drawIcon3D["\A3\ui_f\data\map\markers\military\destroy_ca.paa",[1,0,0,_0mf],ASLtoAGL(getPosWorld _x),_0gf,_0gf,0,_x getVariable "laser_name",0,0.03,"PuristaMedium"];};};}forEach(kgkg8f select _this);},0]call kg77o3;true spawn kg3adh;true spawn kgc7ej;};kgcjfe={if(isnil{_this getVariable "IconsHUD_Fullname"})then{_this setVariable["IconsHUD_Fullname",parseText format["%1 %2",kg6xaz,name _this]];};if(isnil{_this getVariable "IconsHUD_Fullname_Group"})then{_this setVariable["IconsHUD_Fullname_Group",parseText format["%1 <t color='#55cc55'>%2</t>",kg6xaz,name _this]];};if(isnil{_this getVariable "IconsHUD_Fullname_Mic"})then{_this setVariable["IconsHUD_Fullname_Mic",parseText format["%1 %2",kg8oug,name _this]];};if(isnil{_this getVariable "IconsHUD_Fullname_Mic_Group"})then{_this setVariable["IconsHUD_Fullname_Mic_Group",parseText format["%1 <t color='#55cc55'>%2</t>",kg8oug,name _this]];};if(isnil{_this getVariable "IconsHUD_Debugname"})then{_this setVariable["IconsHUD_Debugname",parseText format["%1 %2",format["<img image='%1'/>",(side group _this)call kgrrdk],name _this]];};private["_0th"];_0th=(_this getVariable["koh_level",0]);if((_this getVariable["IconsHUD_Level_Number",-1])!=_0th)then{_this setVariable["IconsHUD_Level_Number",_0th];_this setVariable["IconsHUD_Level",if(_0th<=0)then{text ""}else{parseText("<t align='center'>"+str(_this getVariable["koh_level",0])+"</t>")}];};if(isnil{_this getVariable "IconsHUD_Level"})then{_this setVariable["IconsHUD_Level",text ""];};};kgs8b9={([0.5,0.5]distance2D worldToScreen positionCameraToWorld[0,1.05,1])*(getResolution select 5)};kgoued={_0oh=(_this select 0)select 0;_0ph=(_this select 0)select 1;_0lh=_this select 1;_0qh=_0lh/_0rh;_0gf=0.99 min(((1-(_0qh/40))max 0.35)+0.05);if(_0qh>100&&!kgjf33)then{_0gf=0.2;_0ph=_0ph-0.01;}else{_0ph=_0ph-((1-_0gf)*(0.1*_0gf));};_0gf=_0gf*(SafeZoneW/1.5);_0oh=_0oh-(0.03*_0gf);_09e=(0.5 min((_0lh-10)/60)max 0);[_0oh,_0ph,_0gf,_09e]};kgjd9l={if(count(_this)==0)exitWith{false};if((_0kh select 0)<(safeZoneXAbs-0.2)||(_0kh select 0)>(safeZoneWAbs+0.2)||(_0kh select 1)<(safeZoneY-0.1)||(_0kh select 1)>(safeZoneH+0.1))exitWith{false};true};kgc7ej={waitUntil{if(kgjf33&&kggc9g<serverTime)then{kgjf33=false;};false};};kgl3t3={if(!kgh3ti)exitWith{};kgfvug=_this;switch(kgfvug)do{case kgnxt2:{true spawn kg3adh;};case kg72d6:{true spawn kgqun2;};};};kg77o3={private["_i","_id"];_id=count kgbked;kgbked set[_id,_this];kgkg8f set[_id,[]];kg31on set[count kg31on,[{_this call kg8it8},_id,_this select 2]];_id};kg33lm={if(count(kgbked)>_this)then{kgbked set[_this,nil];kgkg8f=[];};};kgwsl7={private["_0a","_0mh"];disableSerialization;_0a=uiNamespace getVariable "KingOfHill_IconsHUD";kggkd1=0;kgdqul=0;_0mh=call kg64t2;_0rh=call kgs8b9;for "_i" from 0 to count(kgbked)-1 do{if(!kgbr3v)then{_i call(kgbked select _i select 1);};};for "_i" from 0 to((kg82fs max kggkd1)-1)do{if(_i>=kg82fs)then{_0w=_0a displayCtrl(kg3m58+_i);_0w ctrlShow true;};if(_i>=kggkd1)then{_0w=_0a displayCtrl(kg3m58+_i);_0w ctrlShow false;};};for "_i" from 0 to((kgdl67 max kgdqul)-1)do{if(_i>=kgdl67)then{_0w=_0a displayCtrl(kggo2e+_i);_0w ctrlShow true;};if(_i>=kgdqul)then{_0w=_0a displayCtrl(kggo2e+_i);_0w ctrlShow false;};};kg82fs=kggkd1;kgdl67=kgdqul;};kg8it8={private["_0uh","_0hh"];_0uh=kgbked select _this;_0hh=call kgwriv;kgkg8f set[_this,call(_0uh select 0)];};kgosfv={private["_0uh","_0hh"];_0uh=kgbked select _this;while{!isNil{kgbked select _this}}do{_0hh=call kgwriv;kgkg8f set[_this,call(_0uh select 0)];sleep(_0uh select 2);};};kgwriv={private["_0vh"];_0vh=positionCameraToWorld[0,0,0];if(!surfaceIsWater(_0vh))then{_0vh=ATLtoASL(_0vh);}else{if(_0vh select 2<3)then{_0vh set[2,3];};};_0vh};kg64t2={positionCameraToWorld[0,0,0]};kg3adh={kgh3ti=false;sleep 1;kgh3ti=true;kgr69x=addMissionEventHandler["draw3D",kgwsl7];waitUntil{if(visibleMap)then{disableSerialization;_0a=uiNamespace getVariable "KingOfHill_IconsHUD";for "_i" from 0 to(kggkd1-1)do{(_0a displayCtrl(kg3m58+_i))ctrlShow false};for "_i" from 0 to(kgdqul-1)do{(_0a displayCtrl(kggo2e+_i))ctrlShow false};waitUntil{!visibleMap||!kgh3ti};for "_i" from 0 to(kggkd1-1)do{(_0a displayCtrl(kg3m58+_i))ctrlShow true};for "_i" from 0 to(kgdqul-1)do{(_0a displayCtrl(kggo2e+_i))ctrlShow true};};!kgh3ti};if(!isNil{kgr69x})then{removeMissionEventHandler["draw3D",kgr69x];};kggkd1=0;kgdqul=0;};kgqun2={private["_0a"];kgh3ti=false;sleep 1;kgh3ti=true;waitUntil{if(visibleMap)then{disableSerialization;_0a=uiNamespace getVariable "KingOfHill_IconsHUD";for "_i" from 0 to(kggkd1-1)do{(_0a displayCtrl(kg3m58+_i))ctrlShow false};for "_i" from 0 to(kgdqul-1)do{(_0a displayCtrl(kggo2e+_i))ctrlShow false};waitUntil{!visibleMap||!kgh3ti};if(kgh3ti)then{for "_i" from 0 to(kggkd1-1)do{(_0a displayCtrl(kg3m58+_i))ctrlShow true};for "_i" from 0 to(kgdqul-1)do{(_0a displayCtrl(kggo2e+_i))ctrlShow true};};}else{call kgwsl7;};sleep 0.05;!kgh3ti};kggkd1=0;kgdqul=0;};